
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read their own user document and public profiles
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth.uid == userId;
    }

    // Profiles are public to read, but only the owner can write
    match /homeownerProfiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    match /shopOwnerProfiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // Requirements can be created/managed by homeowners.
    // Any authenticated user can read them (for the shop owner dashboard).
    match /requirements/{requirementId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.homeownerId;
      allow update, delete: if request.auth.uid == resource.data.homeownerId;
    }

    // Quotations can be created by shop owners.
    // They can only be read by the shop owner who created them or the homeowner who owns the requirement.
    match /quotations/{quotationId} {
      allow create: if request.auth.uid == request.resource.data.shopOwnerId;
      allow read: if request.auth.uid == resource.data.shopOwnerId || get(/databases/$(database)/documents/requirements/$(resource.data.requirementId)).data.homeownerId == request.auth.uid;
      allow update: if request.auth.uid == resource.data.shopOwnerId;
      allow delete: if false; // Generally, don't allow quote deletion.
    }

    // Updates feed can be read by anyone.
    // Logged-in users can create posts.
    // Users can only edit/delete their own posts.
    match /updates/{updateId} {
        allow read: if request.auth != null;
        allow create: if request.auth.uid == request.resource.data.authorId;
        allow update, delete: if request.auth.uid == resource.data.authorId;
    }
  }
}
